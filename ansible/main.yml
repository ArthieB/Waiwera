---
- hosts: all
  become: yes
  become_user: root
  become_method: sudo
  tasks:
  - name: Install multiple base packages
    apt:
      name: "{{ packages }}"
      state: present
      update_cache: true
    vars:
      packages:
      - g++-6
      - bison=2:3.0.4*
      - flex=2.6.1*
      - cmake=3.7.2*
      - git
      - valgrind=1:3.12.0*
      - zlib1g-dev=1:1.2.8*
      - python
      - gem
      - rake
      - gfortran-6=6.3.0*

  - name: Symlink gfortran-6 to gfortran
    file:
      src: /usr/bin/gfortran-6
      dest: /usr/bin/gfortran
      state: link

  - name: Install python pip
    apt:
      name: python-pip
      state: present

  - name: Update pip to lates version with pip
    pip:
      name: pip

  - name: Intall pip packages
    pip:
      name:
        - virtualenv
        - h5py
        - virtualenvwrapper
        - numpy
        - shapely
        - future
        - pillow
        - matplotlib
        - docutils
        - scipy
        - meshio

  - name: set opt_paths
    copy:
      src: /vagrant/ansible/files/opt_paths.sh
      dest: /etc/profile.d/opt_paths.sh
      remote_src: yes

  - name: Clean app directory structure
    file:
      state: absent
      path: /opt/app/{{ item }}
    with_items:
    - bin
    - lib
    - include

  - name: Creates app directory structure
    file:
      path: "{{ item }}"
      state: directory
      owner: vagrant
      group: vagrant
    with_items:
      - /opt/app
      - /opt/app/bin
      - /opt/app/lib
      - /opt/app/include

- import_playbook: openmpi.yml
- import_playbook: petsc.yml
- import_playbook: fruit.yml
- import_playbook: fson.yml
- import_playbook: supermodels.yml
