---

- name: waiwera - Fetch waiwera from repository
  git:
    repo: "https://{{ waiwera_repo }}"
    dest:  "{{ waiwera_path }}"
    version: "{{ waiwera_version }}"
    update: yes
    force: yes
  register: waiwera_git
  tags:
    - fetch

# - name: get the username running the deploy
#   local_action: command whoami
#   register: username_on_the_host

# - debug: var=username_on_the_host

#
# - name: waiwera - Set file permissions
#   file:
#     dest: "{{ waiwera_path }}"
#     owner: "{{ app_user }}"
#     group: "{{ app_group }}"
#     mode: u=rwX,g=rwX,o=rwX
#     recurse: yes
#   when: docker_run is defined

- name: Build
  block:

  - name: waiwera - Meson build
    shell: meson build --buildtype={{ petsc_arch }} --prefix={{ base_dir }} -Dlibdir=lib -Dset_rpath=true
    args:
      chdir: "{{ waiwera_path }}"
      executable: /bin/bash
    tags:
      - meson
      - build

  - name: waiwera - ninja
    block:
    - name: waiwera - Ninja build
      shell: ninja -C build
      when: ansible_distribution != 'CentOS'
      args:
        chdir: "{{ waiwera_path }}"

    - name: waiwera - Ninja build, CentOS
      shell: "ninja-build -C build"
      when: ansible_distribution == 'CentOS'
      args:
        chdir: "{{ waiwera_path }}"
    tags:
      - ninja
      - build

  when: ((waiwera_git.changed == true) or ( waiwera_update == 'true'))
